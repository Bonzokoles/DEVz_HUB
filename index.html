<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Libraries Visualization</title>
<style>
:root{--bg:#0a0a0f;--s:rgba(255,255,255,0.03);--b:rgba(255,255,255,0.07);--t:#e5e5e5;--ts:#fff;--m:#737373;--d:#525252;--green:#00ff88;--red:#ff0066;--yellow:#ffff00;--blue:#00aaff;--purple:#aa00ff;--pink:#ff00ff}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Courier New',monospace;background:var(--bg);color:var(--t);overflow:hidden;height:100vh}
canvas{display:block}
#canvas-container{width:100%;height:100%}

.top-bar{position:fixed;top:0;left:0;right:0;z-index:50;
  background:rgba(10,10,15,0.85);backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(0,255,136,0.2);padding:12px 20px;
  display:flex;justify-content:space-between;align-items:center}
.top-bar h1{color:var(--green);font-size:14px;font-weight:700;text-shadow:0 0 10px rgba(0,255,136,0.5)}
.top-bar .sub{color:var(--d);font-size:10px;margin-top:2px}
.top-stats{display:flex;gap:16px;font-size:10px;color:var(--m)}
.top-stats .val{color:var(--green);font-weight:700}
.top-stats .blue{color:var(--blue)}
.top-stats .pink{color:var(--pink)}

.panel{position:fixed;z-index:40;background:rgba(10,10,15,0.85);backdrop-filter:blur(10px);
  border:1px solid rgba(0,255,136,0.2);border-radius:8px;padding:14px}

#infoPanel{bottom:12px;left:12px;width:280px;display:none}
#infoPanel h2{color:var(--green);font-size:13px;font-weight:700;margin-bottom:6px}
#infoPanel .desc{color:#aaa;font-size:11px;margin-bottom:8px}
#infoPanel .info-stats{font-size:10px;color:var(--m)}
#infoPanel .info-stats strong{color:var(--ts)}
#infoPanel .info-stats div{margin-bottom:3px}
#infoPanel .subfolder-list{margin-top:8px;max-height:120px;overflow-y:auto}
#infoPanel .subfolder-list div{font-size:9px;color:var(--d);padding:2px 0;border-bottom:1px solid rgba(255,255,255,0.03)}

.legend{position:fixed;bottom:12px;right:12px}
.legend h3{color:var(--m);font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;margin-bottom:8px}
.legend .item{display:flex;align-items:center;gap:8px;font-size:10px;margin-bottom:4px}
.legend .dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

.controls{position:fixed;top:56px;right:12px;font-size:9px;color:#444}
.controls p{margin-bottom:2px}

.view-toggle{position:fixed;top:56px;left:12px;display:flex;gap:4px}
.view-btn{padding:4px 12px;border:1px solid var(--b);border-radius:4px;background:var(--s);
  color:var(--m);font-size:10px;font-family:inherit;cursor:pointer;transition:all .2s}
.view-btn.active,.view-btn:hover{background:rgba(0,255,136,.1);border-color:var(--green);color:var(--green)}

#loading-msg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  color:var(--green);font-size:14px;z-index:60;text-align:center}
#loading-msg .spin{display:inline-block;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- Top Bar -->
<div class="top-bar">
  <div>
    <h1>LIBRARIES VISUALIZATION</h1>
    <div class="sub">U:\The_DEVz_HUB_of_work\LIBRARIES &amp; KNOWLEDGE_BASE</div>
  </div>
  <div class="top-stats">
    <span><span class="val">LIBRARIES:</span> 15</span>
    <span><span class="blue">KB CATEGORIES:</span> 21</span>
    <span><span class="pink">FILES:</span> <span id="totalFiles">---</span></span>
  </div>
</div>

<!-- View Toggle -->
<div class="view-toggle">
  <button class="view-btn active" onclick="setView('3d')">3D Globe</button>
  <button class="view-btn" onclick="setView('tree')">Tree Map</button>
</div>

<!-- Info Panel -->
<div id="infoPanel" class="panel">
  <h2 id="panelTitle">--</h2>
  <div class="desc" id="panelDesc">--</div>
  <div class="info-stats">
    <div>Files: <strong id="statFiles">0</strong></div>
    <div>Subfolders: <strong id="statSubfolders">0</strong></div>
    <div>Type: <strong id="statType">--</strong></div>
  </div>
  <div class="subfolder-list" id="subfolderList"></div>
</div>

<!-- Legend -->
<div class="panel legend">
  <h3>Library Groups</h3>
  <div class="item"><div class="dot" style="background:#00ff88"></div><span style="color:#00ff88">Money Machine</span></div>
  <div class="item"><div class="dot" style="background:#ff0066"></div><span style="color:#ff0066">Bucket of Blood</span></div>
  <div class="item"><div class="dot" style="background:#ffff00"></div><span style="color:#ffff00">The Now</span></div>
  <div class="item"><div class="dot" style="background:#00aaff"></div><span style="color:#00aaff">Shadow Boxing</span></div>
  <div class="item"><div class="dot" style="background:#aa00ff"></div><span style="color:#aa00ff">Knowledge Base</span></div>
  <div class="item"><div class="dot" style="background:#666666"></div><span style="color:#999">Additional</span></div>
</div>

<!-- Controls -->
<div class="panel controls">
  <p>Drag to rotate</p>
  <p>Scroll to zoom</p>
  <p>Click for details</p>
</div>

<!-- Loading -->
<div id="loading-msg"><span class="spin">&#9881;</span> Loading Three.js...</div>

<!-- Three.js 3D Canvas -->
<div id="canvas-container"></div>

<!-- Treemap fallback container -->
<div id="treemap-container" style="display:none;position:absolute;top:50px;left:0;right:0;bottom:0;overflow-y:auto;padding:16px;background:var(--bg)"></div>

<!-- ============================================================
     SCRIPT 1: DATA (no Three.js dependency)
     ============================================================ -->
<script>
var libraryData = {
  libraries: [
    {
      name: "THE_MONEY_MACHINE",
      color: 0x00ff88,
      description: "AI monetization, e-commerce, business tools — primary revenue library",
      subfolders: ["ai-monetization", "ecommerce", "payment-systems", "affiliate-marketing", "cloudflare-workers", "digital-products", "ai-content-creation", "pricing-strategies"],
      files: 14, group: "money",
      position: { x: -8, y: 2, z: 0 }
    },
    {
      name: "THE_BUCKET_OF_BLOOD",
      color: 0xff0066,
      description: "Customer retention, LTV optimization, enterprise sales strategies",
      subfolders: ["customer-retention", "ltv-optimization", "subscription-models", "enterprise-sales", "community-building"],
      files: 3, group: "blood",
      position: { x: 0, y: 6, z: 4 }
    },
    {
      name: "THE_NOW",
      color: 0xffff00,
      description: "Quick cash, arbitrage, viral marketing, instant monetization",
      subfolders: ["flipping-arbitrage", "viral-marketing", "drop-shipping", "gig-economy", "instant-payment"],
      files: 17, group: "now",
      position: { x: 8, y: 2, z: 0 }
    },
    {
      name: "THE_SHADOW_BOXING",
      color: 0x00aaff,
      description: "Growth hacking, competitive intel, automation, psychological triggers",
      subfolders: ["growth-hacking", "competitive-intel", "gray-hat-automation", "aggressive-email", "psychological-triggers"],
      files: 7, group: "shadow",
      position: { x: 0, y: -2, z: -4 }
    }
  ],
  additionalLibraries: [
    { name: "AI_LAB", color: 0x22c55e, files: 6, subfolders: 11, description: "AI experiments, model testing, fine-tuning lab", position: { x: -14, y: 8, z: 2 } },
    { name: "BUSINESS_CENTRE", color: 0xf59e0b, files: 0, subfolders: 10, description: "Business plans, templates, strategies", position: { x: -9, y: 8, z: -3 } },
    { name: "TECH_VAULT", color: 0x3b82f6, files: 2099, subfolders: 17, description: "Technical resources, docs, frameworks — 2099 files", position: { x: -4, y: 8, z: 4 } },
    { name: "PRIVATE_SECTOR", color: 0x64748b, files: 0, subfolders: 11, description: "Private projects, credentials, internal ops", position: { x: 4, y: 8, z: -3 } },
    { name: "TheCHUCKnodle", color: 0xef4444, files: 1911, subfolders: 6, description: "Chuck Norris facts generator — 1911 files", position: { x: 9, y: 8, z: 2 } },
    { name: "business_launches", color: 0x8b5cf6, files: 5, subfolders: 1, description: "Startup launch materials, go-to-market plans", position: { x: 14, y: 8, z: -1 } },
    { name: "low_quality_quarantine", color: 0x78716c, files: 8519, subfolders: 31, description: "Kwarantanna — pliki niskiej jakosci (8519 files)", position: { x: 0, y: 12, z: 0 } }
  ],
  knowledgeBase: [
    { name: "01_AI_SEO", color: 0xaa00ff, files: 3111, indexed: 3912, description: "Strategie SEO pod AI, boty, schema.org", position: { x: -12, y: -6, z: 5 } },
    { name: "02_WHITECAT_SYSTEM", color: 0xaa00ff, files: 0, indexed: 0, description: "Dokumentacja Whitecat", position: { x: -8, y: -6, z: 5 } },
    { name: "03_PYTHON_AUTOMATION", color: 0xaa00ff, files: 0, indexed: 0, description: "Skrypty Python", position: { x: -4, y: -6, z: 5 } },
    { name: "04_ECOMMERCE_SHOPS", color: 0xaa00ff, files: 4, indexed: 23, description: "E-commerce: Astro, Stripe, IdoSell", position: { x: 0, y: -6, z: 5 } },
    { name: "05_AGENTS_AND_RAG", color: 0xaa00ff, files: 12, indexed: 81, description: "Architektura agentow i RAG", position: { x: 4, y: -6, z: 5 } },
    { name: "06_FINANCE", color: 0xaa00ff, files: 4, indexed: 26, description: "Strategie finansowe", position: { x: 8, y: -6, z: 5 } },
    { name: "07_B2B_SALES", color: 0xaa00ff, files: 2, indexed: 13, description: "B2B lead generation", position: { x: 12, y: -6, z: 5 } },
    { name: "08_MARKETPLACE", color: 0x8b5cf6, files: 0, indexed: 0, description: "Allegro, Amazon, eBay", position: { x: -12, y: -6, z: -5 } },
    { name: "09_BUY_AND_SELL", color: 0x8b5cf6, files: 0, indexed: 0, description: "Flipping, okazje rynkowe", position: { x: -8, y: -6, z: -5 } },
    { name: "10_MARKET_ANALYSIS", color: 0x8b5cf6, files: 0, indexed: 0, description: "Raporty, analiza konkurencji", position: { x: -4, y: -6, z: -5 } },
    { name: "11_OPPORTUNITIES", color: 0x8b5cf6, files: 0, indexed: 0, description: "Nowe nisze, mozliwosci", position: { x: 0, y: -6, z: -5 } },
    { name: "12_FORECASTING", color: 0x8b5cf6, files: 0, indexed: 0, description: "Prognozy 2025-2027", position: { x: 4, y: -6, z: -5 } },
    { name: "13_AI_NEWS", color: 0xaa00ff, files: 2, indexed: 12, description: "Nowosci AI, modele, update", position: { x: 8, y: -6, z: -5 } },
    { name: "14_BLOG_TOPICS", color: 0x8b5cf6, files: 0, indexed: 0, description: "Pomysly na artykuly", position: { x: 12, y: -6, z: -5 } },
    { name: "15_READY_ARTICLES", color: 0x8b5cf6, files: 0, indexed: 0, description: "Gotowe artykuly", position: { x: -8, y: -10, z: 0 } },
    { name: "16_PROMPT_LIBRARY", color: 0x8b5cf6, files: 0, indexed: 0, description: "Kolekcja promptow", position: { x: -4, y: -10, z: 0 } },
    { name: "17_AGENT_KNOWLEDGE", color: 0x8b5cf6, files: 0, indexed: 0, description: "Kod i konfiguracja agentow", position: { x: 0, y: -10, z: 0 } },
    { name: "18_MCP_TOOLS", color: 0x8b5cf6, files: 0, indexed: 0, description: "Integracje MCP", position: { x: 4, y: -10, z: 0 } },
    { name: "19_PROJECT_PLANS", color: 0x8b5cf6, files: 0, indexed: 0, description: "Plany i specyfikacje", position: { x: 8, y: -10, z: 0 } },
    { name: "20_TRAINING_CORPUS", color: 0x8b5cf6, files: 0, indexed: 0, description: "Dane treningowe", position: { x: 12, y: -10, z: 0 } },
    { name: "99_ARCHIVE", color: 0x78716c, files: 757, indexed: 0, description: "Archiwum starych plikow", position: { x: 0, y: -14, z: 0 } }
  ],
  chromaDB: {
    totalDocs: 4816, collections: 26, sizeGB: 0.0691,
    activeCategories: 6, position: { x: 0, y: -2, z: 8 }
  }
};

// Calculate totals
var totalFiles = 0;
libraryData.libraries.forEach(function(l) { totalFiles += l.files; });
libraryData.additionalLibraries.forEach(function(l) { totalFiles += l.files; });
libraryData.knowledgeBase.forEach(function(kb) { totalFiles += kb.files; });
document.getElementById('totalFiles').textContent = totalFiles.toLocaleString();

// ========================================================
// INFO PANEL (no THREE dependency)
// ========================================================
function showInfoPanel(data) {
  var panel = document.getElementById('infoPanel');
  panel.style.display = 'block';
  document.getElementById('panelTitle').textContent = data.name;
  document.getElementById('panelDesc').textContent = data.description || '';
  document.getElementById('statFiles').textContent = (data.files || 0).toLocaleString();
  var subCount = Array.isArray(data.subfolders) ? data.subfolders.length : (data.subfolders || 0);
  document.getElementById('statSubfolders').textContent = subCount;
  document.getElementById('statType').textContent = data.group ? 'Main Library' : (data.indexed !== undefined ? 'KB Category' : 'Library');
  if (data.indexed !== undefined) {
    document.getElementById('statType').textContent = 'KB: ' + data.indexed + ' indexed chunks';
  }
  var listEl = document.getElementById('subfolderList');
  if (Array.isArray(data.subfolders) && data.subfolders.length > 0) {
    listEl.innerHTML = data.subfolders.map(function(s) { return '<div>' + s + '</div>'; }).join('');
  } else {
    listEl.innerHTML = '';
  }
}

// ========================================================
// VIEW TOGGLE (no THREE dependency)
// ========================================================
function setView(mode) {
  document.querySelectorAll('.view-btn').forEach(function(b) { b.classList.remove('active'); });
  var btn = document.querySelector('.view-btn[onclick*="' + mode + '"]');
  if (btn) btn.classList.add('active');
  if (mode === 'tree') {
    document.getElementById('canvas-container').style.display = 'none';
    var tm = document.getElementById('treemap-container');
    tm.style.display = 'block';
    renderTreemap(tm);
  } else {
    document.getElementById('canvas-container').style.display = '';
    document.getElementById('treemap-container').style.display = 'none';
  }
}

function hexStr(num) {
  return '#' + num.toString(16).padStart(6, '0');
}

function renderTreemap(container) {
  var allItems = [
    { label: 'MAIN LIBRARIES', items: libraryData.libraries.map(function(l) { return { name: l.name, files: l.files, color: hexStr(l.color), desc: l.description }; }) },
    { label: 'ADDITIONAL', items: libraryData.additionalLibraries.map(function(l) { return { name: l.name, files: l.files, color: hexStr(l.color), desc: l.description }; }) },
    { label: 'KNOWLEDGE BASE', items: libraryData.knowledgeBase.map(function(k) { return { name: k.name, files: k.files, indexed: k.indexed, color: hexStr(k.color), desc: k.description }; }) }
  ];
  container.innerHTML = allItems.map(function(group) {
    return '<div style="margin-bottom:24px">' +
      '<div style="font-size:11px;font-weight:700;color:#00ff88;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;font-family:Courier New">' + group.label + '</div>' +
      '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">' +
      group.items.map(function(item) {
        return '<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:12px;border-left:3px solid ' + item.color + ';opacity:' + (item.files > 0 ? 1 : 0.4) + '">' +
          '<div style="font-size:12px;font-weight:700;color:#fff;margin-bottom:4px">' + item.name + '</div>' +
          '<div style="font-size:9px;color:#737373;margin-bottom:6px">' + (item.desc || '') + '</div>' +
          '<div style="display:flex;gap:12px;font-size:10px">' +
            '<span style="color:' + item.color + '">' + item.files.toLocaleString() + ' files</span>' +
            (item.indexed !== undefined ? '<span style="color:#ff00ff">' + item.indexed + ' indexed</span>' : '') +
          '</div></div>';
      }).join('') +
      '</div></div>';
  }).join('');
}
</script>

<!-- ============================================================
     SCRIPT 2: Three.js r128 classic global build (no import maps!)
     ============================================================ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" crossorigin="anonymous"></script>

<!-- ============================================================
     SCRIPT 3: 3D SCENE (depends on THREE global from r128)
     ============================================================ -->
<script>
(function() {
  var loadingEl = document.getElementById('loading-msg');

  if (typeof THREE === 'undefined') {
    loadingEl.innerHTML = '<span style="color:#ff0066">Three.js failed to load.<br>Switching to TreeMap...</span>';
    setTimeout(function() { loadingEl.style.display = 'none'; setView('tree'); }, 1500);
    return;
  }
  loadingEl.style.display = 'none';
  console.log('[LibViz] Three.js r' + THREE.REVISION + ' loaded OK');

  // ========================================================
  // THREE.JS SCENE SETUP
  // ========================================================
  var scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0x0a0a0f, 0.015);

  var camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, 8, 30);

  var renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  document.getElementById('canvas-container').appendChild(renderer.domElement);

  var controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.05;
  controls.minDistance = 5;
  controls.maxDistance = 50;
  controls.autoRotate = true;
  controls.autoRotateSpeed = 0.3;

  // Lighting
  scene.add(new THREE.AmbientLight(0x404040, 0.5));
  var light1 = new THREE.PointLight(0x00ff88, 1.2, 100);
  light1.position.set(10, 10, 10);
  scene.add(light1);
  var light2 = new THREE.PointLight(0x00aaff, 0.8, 100);
  light2.position.set(-10, -10, 10);
  scene.add(light2);
  var light3 = new THREE.PointLight(0xaa00ff, 0.6, 80);
  light3.position.set(0, -15, -5);
  scene.add(light3);

  var interactiveObjects = [];

  // ---- Sphere factories ----
  function createGlowingSphere(data, size) {
    size = size || 2;
    var group = new THREE.Group();

    var geo = new THREE.SphereGeometry(size, 32, 32);
    var mat = new THREE.MeshStandardMaterial({
      color: data.color, emissive: data.color, emissiveIntensity: 0.3,
      metalness: 0.8, roughness: 0.2, transparent: true, opacity: 0.9
    });
    var sphere = new THREE.Mesh(geo, mat);
    sphere.userData = data;
    group.add(sphere);
    interactiveObjects.push(sphere);

    // Glow layers
    group.add(new THREE.Mesh(
      new THREE.SphereGeometry(size * 1.2, 32, 32),
      new THREE.MeshBasicMaterial({ color: data.color, transparent: true, opacity: 0.15, side: THREE.BackSide })
    ));
    group.add(new THREE.Mesh(
      new THREE.SphereGeometry(size * 1.5, 32, 32),
      new THREE.MeshBasicMaterial({ color: data.color, transparent: true, opacity: 0.05, side: THREE.BackSide })
    ));

    // Canvas label
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');
    canvas.width = 512; canvas.height = 128;
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 22px Courier New';
    ctx.textAlign = 'center';
    var displayName = data.name.length > 20 ? data.name.substring(0, 20) + '...' : data.name;
    ctx.fillText(displayName, 256, 50);
    if (data.files > 0) {
      ctx.fillStyle = '#00ff88';
      ctx.font = '16px Courier New';
      ctx.fillText(data.files.toLocaleString() + ' files', 256, 80);
    }
    var texture = new THREE.CanvasTexture(canvas);
    var label = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture, transparent: true }));
    label.position.y = size + 1.2;
    label.scale.set(6, 1.5, 1);
    group.add(label);

    group.position.set(data.position.x, data.position.y, data.position.z);
    return group;
  }

  function createMiniSphere(data, size) {
    size = size || 0.5;
    var hasFiles = (data.files || 0) > 0 || (data.indexed || 0) > 0;
    var geo = new THREE.SphereGeometry(size, 16, 16);
    var mat = new THREE.MeshStandardMaterial({
      color: data.color, emissive: data.color,
      emissiveIntensity: hasFiles ? 0.5 : 0.1,
      metalness: 0.5, roughness: 0.3,
      transparent: true, opacity: hasFiles ? 0.8 : 0.3
    });
    var sphere = new THREE.Mesh(geo, mat);
    sphere.userData = data;
    sphere.position.set(data.position.x, data.position.y, data.position.z);
    interactiveObjects.push(sphere);
    return sphere;
  }

  function createConnection(start, end, color, opacity) {
    opacity = opacity || 0.3;
    var geo = new THREE.BufferGeometry().setFromPoints([
      new THREE.Vector3(start.x, start.y, start.z),
      new THREE.Vector3(end.x, end.y, end.z)
    ]);
    return new THREE.Line(geo, new THREE.LineBasicMaterial({ color: color, transparent: true, opacity: opacity }));
  }

  // ---- Particles ----
  var pGeo = new THREE.BufferGeometry();
  var pCount = 1500;
  var pPos = new Float32Array(pCount * 3);
  for (var i = 0; i < pCount * 3; i += 3) {
    pPos[i] = (Math.random() - 0.5) * 80;
    pPos[i+1] = (Math.random() - 0.5) * 50;
    pPos[i+2] = (Math.random() - 0.5) * 80;
  }
  pGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
  var particles = new THREE.Points(pGeo, new THREE.PointsMaterial({
    color: 0x00ff88, size: 0.08, transparent: true, opacity: 0.4
  }));
  scene.add(particles);

  // ---- Grid ----
  var gridHelper = new THREE.GridHelper(40, 20, 0x00ff88, 0x00ff88);
  gridHelper.position.y = -16;
  gridHelper.material.transparent = true;
  gridHelper.material.opacity = 0.1;
  scene.add(gridHelper);

  // ---- Build scene from data ----
  // Main library spheres
  libraryData.libraries.forEach(function(lib) {
    var sz = Math.max(1.2, Math.min(3, Math.sqrt(lib.files) * 0.4 + 1));
    scene.add(createGlowingSphere(lib, sz));
  });

  // Additional libraries
  libraryData.additionalLibraries.forEach(function(lib) {
    var sz = Math.max(0.6, Math.min(2.5, Math.sqrt(lib.files) * 0.04 + 0.6));
    scene.add(createGlowingSphere(lib, sz));
  });

  // KB categories
  libraryData.knowledgeBase.forEach(function(kb) {
    var sz = kb.files > 0 ? Math.max(0.4, Math.min(1.5, Math.sqrt(kb.files) * 0.025 + 0.4)) : 0.25;
    scene.add(createMiniSphere(kb, sz));
  });

  // ChromaDB central sphere
  var chromaData = {
    name: "ChromaDB Vector Store",
    color: 0xff00ff,
    files: libraryData.chromaDB.totalDocs,
    description: 'Vector DB: ' + libraryData.chromaDB.totalDocs + ' docs, ' + libraryData.chromaDB.collections + ' collections, ' + (libraryData.chromaDB.sizeGB * 1024).toFixed(1) + ' MB',
    subfolders: [libraryData.chromaDB.activeCategories + ' active categories', libraryData.chromaDB.collections + ' collections'],
    position: libraryData.chromaDB.position
  };
  scene.add(createGlowingSphere(chromaData, 1.8));

  // Connections — main libs to center
  var center = { x: 0, y: 0, z: 0 };
  libraryData.libraries.forEach(function(lib) {
    scene.add(createConnection(center, lib.position, lib.color));
  });

  // Connections — KB to ChromaDB
  libraryData.knowledgeBase.forEach(function(kb) {
    if (kb.files > 0) {
      scene.add(createConnection(kb.position, libraryData.chromaDB.position, 0xff00ff, 0.2));
    }
  });

  // ---- Raycaster interaction ----
  var raycaster = new THREE.Raycaster();
  var mouse = new THREE.Vector2();
  var hoveredObj = null;

  function onMouseMove(event) {
    var rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    var intersects = raycaster.intersectObjects(interactiveObjects);
    if (intersects.length > 0) {
      var obj = intersects[0].object;
      if (hoveredObj !== obj) {
        if (hoveredObj) hoveredObj.material.emissiveIntensity = hoveredObj.userData._origEI || 0.3;
        hoveredObj = obj;
        hoveredObj.userData._origEI = hoveredObj.material.emissiveIntensity;
        hoveredObj.material.emissiveIntensity = 0.8;
      }
      document.body.style.cursor = 'pointer';
      showInfoPanel(obj.userData);
    } else {
      if (hoveredObj) {
        hoveredObj.material.emissiveIntensity = hoveredObj.userData._origEI || 0.3;
        hoveredObj = null;
      }
      document.body.style.cursor = 'default';
    }
  }

  window.addEventListener('mousemove', onMouseMove);
  window.addEventListener('click', onMouseMove);

  window.addEventListener('resize', function() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // ---- Animation loop ----
  var time = 0;
  function animate() {
    requestAnimationFrame(animate);
    time += 0.01;
    controls.update();
    particles.rotation.y += 0.0005;
    particles.rotation.x += 0.0002;
    interactiveObjects.forEach(function(obj, i) {
      obj.position.y += Math.sin(time * 0.8 + i * 0.5) * 0.001;
    });
    renderer.render(scene, camera);
  }
  animate();
  console.log('[LibViz] 3D scene ready — ' + interactiveObjects.length + ' objects');
})();
</script>
</body>
</html>
