<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biblioteki ‚Äî PrzeglƒÖdarka</title>
<style>
:root{
  --bg:#07090f;--bg2:#0b0f1a;--s:rgba(255,255,255,0.03);--sh:rgba(255,255,255,0.06);
  --b:rgba(255,255,255,0.07);--bh:rgba(255,255,255,0.12);
  --green:#00ff88;--cyan:#00d9ff;--purple:#a855f7;--indigo:#6366f1;
  --yellow:#facc15;--red:#f87171;--orange:#f97316;--pink:#ec4899;
  --text:#e5e5e5;--strong:#fff;--muted:#737373;--dim:#525252;
  --sidebar-w:260px;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);font-size:13px}

/* ===== LAYOUT ===== */
.layout{display:flex;height:100vh}

/* ===== LEFT SIDEBAR ‚Äî library list ===== */
.lib-sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  background:linear-gradient(180deg,#0c1020 0%,#080b14 100%);
  border-right:1px solid var(--b);
  display:flex;flex-direction:column;overflow:hidden;
}
.lib-sidebar-hdr{
  padding:14px 16px 10px;
  border-bottom:1px solid var(--b);
}
.lib-sidebar-hdr h1{font-size:13px;font-weight:700;color:var(--strong)}
.lib-sidebar-hdr .sub{font-size:9px;color:var(--dim);margin-top:2px}
.lib-status{display:flex;align-items:center;gap:5px;font-size:9px;color:var(--dim);margin-top:6px}
.lib-status .dot{width:6px;height:6px;border-radius:50%;background:var(--dim)}
.lib-status .dot.ok{background:var(--green);box-shadow:0 0 5px var(--green)}
.lib-status .dot.err{background:var(--red)}

.lib-search{padding:8px 12px;border-bottom:1px solid var(--b)}
.lib-search input{
  width:100%;padding:6px 10px;background:rgba(255,255,255,0.04);
  border:1px solid var(--b);border-radius:6px;color:var(--text);
  font-size:11px;font-family:inherit;outline:none;
}
.lib-search input:focus{border-color:var(--green)}
.lib-search input::placeholder{color:var(--dim)}

.lib-tree{flex:1;overflow-y:auto;padding:8px 0}
.lib-tree::-webkit-scrollbar{width:4px}
.lib-tree::-webkit-scrollbar-thumb{background:var(--b);border-radius:2px}

.lib-group{margin-bottom:4px}
.lib-group-hdr{
  padding:6px 12px;font-size:9px;font-weight:700;
  text-transform:uppercase;letter-spacing:1.2px;color:var(--dim);
  display:flex;align-items:center;gap:6px;cursor:pointer;
  transition:color .15s;
}
.lib-group-hdr:hover{color:var(--muted)}
.lib-group-hdr .badge{
  font-size:8px;padding:1px 6px;border-radius:4px;font-weight:600;
  background:rgba(255,255,255,0.06);color:var(--dim);margin-left:auto;
}

.lib-item{
  padding:7px 12px 7px 20px;font-size:11px;cursor:pointer;
  display:flex;align-items:center;gap:8px;
  border-left:2px solid transparent;transition:all .15s;
  color:var(--muted);
}
.lib-item:hover{background:rgba(255,255,255,0.03);color:var(--text)}
.lib-item.active{
  background:rgba(0,255,136,0.06);border-left-color:var(--green);
  color:var(--strong);
}
.lib-item .lib-icon{width:18px;height:18px;border-radius:4px;
  display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.lib-item .lib-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lib-item .lib-count{font-size:9px;color:var(--dim);flex-shrink:0}

.lib-subitem{
  padding:5px 12px 5px 36px;font-size:10px;cursor:pointer;
  display:flex;align-items:center;gap:6px;color:var(--dim);
  border-left:2px solid transparent;transition:all .15s;
}
.lib-subitem:hover{background:rgba(255,255,255,0.02);color:var(--muted)}
.lib-subitem.active{background:rgba(0,217,255,0.05);border-left-color:var(--cyan);color:var(--text)}
.lib-subitem .sub-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lib-subitem .sub-count{font-size:9px;color:var(--dim)}

/* ===== MAIN CONTENT ===== */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* Topbar */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;border-bottom:1px solid var(--b);
  background:rgba(11,15,26,0.8);flex-shrink:0;
}
.topbar-left{display:flex;align-items:center;gap:10px}
.breadcrumb{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--dim)}
.breadcrumb .bc-sep{color:var(--dim)}
.breadcrumb .bc-lib{color:var(--green);cursor:pointer}
.breadcrumb .bc-lib:hover{text-decoration:underline}
.breadcrumb .bc-cat{color:var(--cyan)}
.breadcrumb .bc-subcat{color:var(--text)}
.topbar-right{display:flex;align-items:center;gap:12px;font-size:11px;color:var(--dim)}
.topbar-stat{display:flex;align-items:center;gap:5px}

/* View toolbar */
.view-toolbar{
  padding:8px 16px;border-bottom:1px solid var(--b);
  display:flex;align-items:center;gap:8px;flex-shrink:0;
  background:rgba(7,9,15,0.5);
}
.view-btn{
  padding:4px 10px;font-size:10px;border:1px solid var(--b);border-radius:5px;
  background:transparent;color:var(--dim);cursor:pointer;transition:all .15s;font-family:inherit;
}
.view-btn:hover{border-color:var(--bh);color:var(--text)}
.view-btn.active{border-color:var(--green);color:var(--green);background:rgba(0,255,136,0.06)}
.view-sep{width:1px;height:16px;background:var(--b);margin:0 2px}
.view-filter{
  flex:1;padding:4px 10px;font-size:11px;background:rgba(255,255,255,0.03);
  border:1px solid var(--b);border-radius:5px;color:var(--text);
  font-family:inherit;outline:none;max-width:240px;
}
.view-filter:focus{border-color:var(--cyan)}
.view-filter::placeholder{color:var(--dim)}
.view-label{font-size:9px;color:var(--dim);margin-left:auto}

/* ===== FILE GRID ===== */
.content-area{flex:1;overflow-y:auto;padding:16px}
.content-area::-webkit-scrollbar{width:5px}
.content-area::-webkit-scrollbar-thumb{background:var(--b);border-radius:3px}

/* Overview cards */
.overview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:20px}
.ov-card{
  background:var(--s);border:1px solid var(--b);border-radius:10px;
  padding:14px;cursor:pointer;transition:all .2s;
  position:relative;overflow:hidden;
}
.ov-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:var(--card-color,var(--green));opacity:0.6;
}
.ov-card:hover{border-color:var(--card-color,var(--green));transform:translateY(-2px);background:var(--sh)}
.ov-card-icon{font-size:22px;margin-bottom:8px}
.ov-card-name{font-size:12px;font-weight:700;color:var(--strong);margin-bottom:4px}
.ov-card-desc{font-size:10px;color:var(--dim);margin-bottom:8px;line-height:1.4}
.ov-card-stats{display:flex;gap:10px;font-size:10px;color:var(--muted)}
.ov-card-stats strong{color:var(--text)}

/* File list */
.file-list{display:flex;flex-direction:column;gap:6px}
.file-item{
  display:flex;align-items:center;gap:10px;padding:10px 14px;
  background:var(--s);border:1px solid var(--b);border-radius:8px;
  cursor:pointer;transition:all .15s;
}
.file-item:hover{border-color:var(--bh);background:var(--sh)}
.file-item.active{border-color:var(--green);background:rgba(0,255,136,0.04)}
.file-ext{
  width:34px;height:34px;border-radius:6px;display:flex;align-items:center;
  justify-content:center;font-size:9px;font-weight:700;
  background:rgba(255,255,255,0.04);color:var(--muted);flex-shrink:0;
  text-transform:uppercase;
}
.file-ext.md{background:rgba(99,102,241,0.12);color:var(--indigo)}
.file-ext.json{background:rgba(250,204,21,0.12);color:var(--yellow)}
.file-ext.txt{background:rgba(115,115,115,0.12);color:var(--muted)}
.file-ext.py{background:rgba(59,130,246,0.12);color:#60a5fa}
.file-info{flex:1;min-width:0}
.file-name{font-size:12px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-meta{font-size:10px;color:var(--dim);margin-top:2px}
.file-size{font-size:10px;color:var(--dim);flex-shrink:0}
.file-date{font-size:10px;color:var(--dim);flex-shrink:0;width:80px;text-align:right}

/* File grid (card) view */
.file-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
.file-card{
  background:var(--s);border:1px solid var(--b);border-radius:8px;
  padding:12px;cursor:pointer;transition:all .15s;
}
.file-card:hover{border-color:var(--bh);background:var(--sh)}
.file-card .fc-ext{
  font-size:9px;font-weight:700;text-transform:uppercase;
  padding:2px 6px;border-radius:4px;display:inline-block;
  background:rgba(255,255,255,0.04);color:var(--dim);margin-bottom:8px;
}
.file-card .fc-name{font-size:11px;font-weight:600;color:var(--text);word-break:break-word;line-height:1.3;margin-bottom:6px}
.file-card .fc-meta{font-size:9px;color:var(--dim)}

/* ===== FILE READER PANEL ===== */
.reader-overlay{
  position:fixed;inset:0;z-index:200;
  background:rgba(4,6,12,0.92);backdrop-filter:blur(8px);
  display:flex;align-items:center;justify-content:center;
  padding:20px;
}
.reader-panel{
  background:#0d1117;border:1px solid var(--b);border-radius:12px;
  width:100%;max-width:820px;max-height:85vh;display:flex;flex-direction:column;
  box-shadow:0 24px 80px rgba(0,0,0,0.6);
}
.reader-hdr{
  display:flex;align-items:center;gap:10px;padding:14px 16px;
  border-bottom:1px solid var(--b);flex-shrink:0;
}
.reader-hdr .rh-ext{
  font-size:9px;font-weight:700;text-transform:uppercase;
  padding:2px 8px;border-radius:4px;background:rgba(99,102,241,0.15);color:var(--indigo);
}
.reader-hdr .rh-name{font-size:13px;font-weight:700;color:var(--strong);flex:1}
.reader-hdr .rh-meta{font-size:10px;color:var(--dim)}
.reader-close{
  padding:4px 8px;font-size:18px;cursor:pointer;color:var(--dim);
  background:none;border:none;font-family:inherit;transition:color .15s;
}
.reader-close:hover{color:var(--text)}
.reader-body{flex:1;overflow-y:auto;padding:16px}
.reader-body::-webkit-scrollbar{width:5px}
.reader-body::-webkit-scrollbar-thumb{background:var(--b);border-radius:3px}
.reader-content{
  font-size:12px;line-height:1.7;color:var(--text);white-space:pre-wrap;
  word-break:break-word;font-family:'Consolas','Courier New',monospace;
}
.reader-content.md-rendered{font-family:'Segoe UI',system-ui,sans-serif}
.reader-tabs{display:flex;gap:4px;padding:8px 16px;border-bottom:1px solid var(--b);flex-shrink:0}
.reader-tab{
  padding:4px 10px;font-size:10px;border:1px solid var(--b);border-radius:5px;
  background:transparent;color:var(--dim);cursor:pointer;font-family:inherit;transition:all .15s;
}
.reader-tab.active{border-color:var(--green);color:var(--green);background:rgba(0,255,136,0.06)}
.reader-tab:hover:not(.active){color:var(--text)}

/* ===== LOADING & EMPTY ===== */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;color:var(--dim)}
.loading .spin{width:24px;height:24px;border:2px solid var(--b);border-top-color:var(--green);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 20px;color:var(--dim)}
.empty .empty-icon{font-size:40px;margin-bottom:12px;opacity:.5}
.empty .empty-msg{font-size:13px}
.empty .empty-sub{font-size:10px;margin-top:4px}

/* Section label */
.section-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--dim);margin:0 0 10px;display:flex;align-items:center;gap:8px}

/* Folder cards in content */
.folder-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-bottom:16px}
.folder-card{
  background:var(--s);border:1px solid var(--b);border-radius:8px;
  padding:12px;cursor:pointer;transition:all .15s;
  display:flex;align-items:center;gap:8px;
}
.folder-card:hover{border-color:var(--bh);background:var(--sh);transform:translateY(-1px)}
.folder-card .fc-ico{font-size:18px;flex-shrink:0}
.folder-card .fc-info .fc-n{font-size:11px;font-weight:600;color:var(--text)}
.folder-card .fc-info .fc-s{font-size:9px;color:var(--dim);margin-top:2px}

/* ===== RESPONSIVE ===== */
@media(max-width:700px){.lib-sidebar{display:none}.content-area{padding:10px}}
</style>
</head>
<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="lib-sidebar" id="sidebar">
    <div class="lib-sidebar-hdr">
      <h1>üìö Biblioteki</h1>
      <div class="sub">knowledge_base/_LIBRARIES</div>
      <div class="lib-status">
        <div class="dot" id="statusDot"></div>
        <span id="statusLabel">≈Åadowanie...</span>
      </div>
    </div>
    <div class="lib-search">
      <input type="text" id="sidebarSearch" placeholder="Szukaj biblioteki..." oninput="filterSidebar(this.value)" />
    </div>
    <div class="lib-tree" id="libTree">
      <div class="loading"><div class="spin"></div><span>Pobieranie...</span></div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <!-- Topbar -->
    <div class="topbar">
      <div class="topbar-left">
        <div class="breadcrumb" id="breadcrumb">
          <span class="bc-lib" onclick="goHome()">Biblioteki</span>
        </div>
      </div>
      <div class="topbar-right">
        <div class="topbar-stat" id="topStat">≈Åadowanie...</div>
        <div class="lib-status">
          <div class="dot" id="topDot"></div>
          <span id="topLabel">API</span>
        </div>
      </div>
    </div>

    <!-- View toolbar -->
    <div class="view-toolbar">
      <button class="view-btn active" id="btnList" onclick="setView('list')">‚ò∞ Lista</button>
      <button class="view-btn" id="btnGrid" onclick="setView('grid')">‚äû Karty</button>
      <div class="view-sep"></div>
      <input type="text" class="view-filter" id="fileFilter" placeholder="Filtruj pliki..." oninput="filterFiles(this.value)" />
      <span class="view-label" id="fileCount"></span>
    </div>

    <!-- Content -->
    <div class="content-area" id="contentArea">
      <div class="loading"><div class="spin"></div><span>≈Åadowanie bibliotek...</span></div>
    </div>
  </div>
</div>

<!-- FILE READER OVERLAY -->
<div class="reader-overlay" id="readerOverlay" style="display:none" onclick="closeReader(event)">
  <div class="reader-panel" onclick="event.stopPropagation()">
    <div class="reader-hdr">
      <span class="rh-ext" id="rdrExt">md</span>
      <span class="rh-name" id="rdrName">file.md</span>
      <span class="rh-meta" id="rdrMeta"></span>
      <button class="reader-close" onclick="closeReader()">‚úï</button>
    </div>
    <div class="reader-tabs">
      <button class="reader-tab active" id="tabRendered" onclick="switchTab('rendered')">üìñ Widok</button>
      <button class="reader-tab" id="tabRaw" onclick="switchTab('raw')">üî§ ≈πr√≥d≈Ço</button>
      <button class="reader-tab" id="tabHtml" onclick="switchTab('html')">üåê HTML</button>
      <button class="reader-tab" style="margin-left:auto;border-color:var(--cyan);color:var(--cyan)" onclick="saveAsHtml()">üåç Otw√≥rz jako stronƒô</button>
    </div>
    <div class="reader-body">
      <div class="reader-content" id="rdrContent"></div>
    </div>
  </div>
</div>

<script>
// ================================================================
// CONFIG
// ================================================================
const API = 'http://localhost:4200';
const LIB_ROOT = '[BIZ]';

// Library metadata ‚Äî kolory i ikony
const LIB_META = {
  'THE_MONEY_MACHINE':  { icon:'üí∞', color:'#facc15', desc:'AI monetization, e-commerce, payment-systems' },
  'THE_BUCKET_OF_BLOOD':{ icon:'ü©∏', color:'#ef4444', desc:'Customer retention, LTV, enterprise sales' },
  'THE_NOW':            { icon:'‚ö°', color:'#00ff88', desc:'Quick cash, arbitrage, viral marketing' },
  'THE_SHADOW_BOXING':  { icon:'ü•ä', color:'#a855f7', desc:'Competitive intel, growth hacking, psych triggers' },
  'business_launches':  { icon:'üöÄ', color:'#f97316', desc:'Nowe projekty i launche biznesowe' },
  'BUSINESS_CENTRE':    { icon:'üè¢', color:'#00d9ff', desc:'Centrum operacyjne ‚Äî klienci, kontrakty, finanse' },
  'AI_LAB':             { icon:'üß™', color:'#6366f1', desc:'Agenty, modele, workflow, konfiguracje AI' },
  'TECH_VAULT':         { icon:'üîê', color:'#22c55e', desc:'Frameworki, API, kod ≈∫r√≥d≈Çowy, bezpiecze≈Ñstwo' },
  'PRIVATE_SECTOR':     { icon:'üîí', color:'#737373', desc:'Dokumenty prywatne ‚Äî certyfikaty, zdrowie, finanse' },
  'TheCHUCKnodle':      { icon:'ü§ñ', color:'#ec4899', desc:'Aplikacja Nodle ‚Äî Python, FastAPI' },
  'low_quality_quarantine':{ icon:'üóëÔ∏è', color:'#525252', desc:'Kwarantanna niskiej jako≈õci (8519 pliki)' },
};

// State
let state = {
  libraries: [],         // [{prefix, name, icon, color, desc, path, files, subfolders}]
  activeLib: null,
  activeSubfolder: null,
  view: 'list',
  files: [],
  allFiles: [],
  rawContent: '',
  renderedContent: '',
  readerTab: 'rendered',
};

// ================================================================
// INIT
// ================================================================
async function init() {
  await loadLibraries();
}

async function loadLibraries() {
  try {
    const res = await fetch(API + '/api/browse/categories?root=lib', { signal: AbortSignal.timeout(5000) });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    setOnline(true, data.categories.length + ' bibliotek');
    buildLibraries(data.categories);
  } catch(e) {
    setOnline(false, 'Serwer offline');
    showError('Nie mo≈ºna po≈ÇƒÖczyƒá z API na localhost:4200', 'Uruchom: python server.py');
  }
}

function buildLibraries(cats) {
  // Grup BIZ vs PRV
  const biz = cats.filter(c => c.name.startsWith('[BIZ]'));
  const prv = cats.filter(c => c.name.startsWith('[PRV]'));
  const other = cats.filter(c => !c.name.startsWith('[BIZ]') && !c.name.startsWith('[PRV]'));

  state.libraries = cats.map(c => {
    const rawName = c.name.replace(/^\[(BIZ|PRV)\]\s*/, '');
    const prefix = c.name.startsWith('[BIZ]') ? 'BIZ' : c.name.startsWith('[PRV]') ? 'PRV' : '';
    const meta = LIB_META[rawName] || { icon: 'üìÅ', color: '#737373', desc: '' };
    return { ...c, prefix, rawName, ...meta };
  });

  renderSidebar(biz, prv, other);
  renderHome();
}

// ================================================================
// SIDEBAR
// ================================================================
function renderSidebar(biz, prv, other) {
  const tree = document.getElementById('libTree');
  let html = '';

  if (biz.length) {
    html += `<div class="lib-group">
      <div class="lib-group-hdr" onclick="toggleGroup('biz')">
        <span>üíº BIZ</span>
        <span class="badge">${biz.length}</span>
      </div>
      <div id="grp-biz">`;
    biz.forEach(c => {
      const rawName = c.name.replace(/^\[BIZ\]\s*/, '');
      const meta = LIB_META[rawName] || { icon:'üìÅ', color:'#737373' };
      html += `<div class="lib-item" data-lib="${c.name}" onclick="selectLib('${esc(c.name)}')">
        <div class="lib-icon" style="background:${meta.color}18;color:${meta.color}">${meta.icon}</div>
        <span class="lib-name">${rawName}</span>
        <span class="lib-count">${c.files}f ${c.subfolders}d</span>
      </div>`;
    });
    html += `</div></div>`;
  }

  if (prv.length) {
    html += `<div class="lib-group">
      <div class="lib-group-hdr" onclick="toggleGroup('prv')">
        <span>üîí PRV</span>
        <span class="badge">${prv.length}</span>
      </div>
      <div id="grp-prv">`;
    prv.forEach(c => {
      const rawName = c.name.replace(/^\[PRV\]\s*/, '');
      const meta = LIB_META[rawName] || { icon:'üìÅ', color:'#737373' };
      html += `<div class="lib-item" data-lib="${c.name}" onclick="selectLib('${esc(c.name)}')">
        <div class="lib-icon" style="background:${meta.color}18;color:${meta.color}">${meta.icon}</div>
        <span class="lib-name">${rawName}</span>
        <span class="lib-count">${c.files}f ${c.subfolders}d</span>
      </div>`;
    });
    html += `</div></div>`;
  }

  if (other.length) {
    html += `<div class="lib-group">
      <div class="lib-group-hdr">üì¶ Inne</div>`;
    other.forEach(c => {
      html += `<div class="lib-item" data-lib="${c.name}" onclick="selectLib('${esc(c.name)}')">
        <div class="lib-icon">üìÅ</div>
        <span class="lib-name">${c.name}</span>
        <span class="lib-count">${c.files}f</span>
      </div>`;
    });
    html += `</div>`;
  }

  tree.innerHTML = html || '<div style="padding:20px;color:var(--dim);font-size:11px">Brak bibliotek</div>';
  updateTopStat();
}

function filterSidebar(q) {
  q = q.toLowerCase();
  document.querySelectorAll('.lib-item').forEach(el => {
    el.style.display = el.dataset.lib.toLowerCase().includes(q) ? '' : 'none';
  });
}

function toggleGroup(id) {
  const el = document.getElementById('grp-' + id);
  if (el) el.style.display = el.style.display === 'none' ? '' : 'none';
}

function setActiveLib(libName) {
  document.querySelectorAll('.lib-item').forEach(el => el.classList.remove('active'));
  const el = document.querySelector(`.lib-item[data-lib="${libName}"]`);
  if (el) el.classList.add('active');
}

// ================================================================
// HOME ‚Äî overview
// ================================================================
function renderHome() {
  state.activeLib = null;
  state.activeSubfolder = null;
  updateBreadcrumb([]);
  updateTopStat();
  document.getElementById('fileFilter').value = '';
  document.getElementById('fileCount').textContent = '';
  document.querySelectorAll('.lib-item').forEach(el => el.classList.remove('active'));

  const biz = state.libraries.filter(l => l.prefix === 'BIZ');
  const prv = state.libraries.filter(l => l.prefix === 'PRV');

  let html = '';
  if (biz.length) {
    html += `<div class="section-lbl">üíº Biblioteki BIZ <span style="color:var(--muted);font-weight:400">(${biz.length})</span></div>`;
    html += '<div class="overview-grid">';
    biz.forEach(lib => {
      html += makeOverviewCard(lib);
    });
    html += '</div>';
  }
  if (prv.length) {
    html += `<div class="section-lbl">üîí Biblioteki PRV <span style="color:var(--muted);font-weight:400">(${prv.length})</span></div>`;
    html += '<div class="overview-grid">';
    prv.forEach(lib => {
      html += makeOverviewCard(lib);
    });
    html += '</div>';
  }

  document.getElementById('contentArea').innerHTML = html || '<div class="empty"><div class="empty-icon">üìö</div><div class="empty-msg">Brak bibliotek</div></div>';
}

function makeOverviewCard(lib) {
  return `
    <div class="ov-card" style="--card-color:${lib.color}" onclick="selectLib('${esc(lib.name)}')">
      <div class="ov-card-icon">${lib.icon}</div>
      <div class="ov-card-name">${lib.rawName}</div>
      <div class="ov-card-desc">${lib.desc}</div>
      <div class="ov-card-stats">
        <span>üìÑ <strong>${lib.files}</strong> pliki</span>
        <span>üìÅ <strong>${lib.subfolders}</strong> foldery</span>
      </div>
    </div>`;
}

// ================================================================
// SELECT LIBRARY
// ================================================================
async function selectLib(libName) {
  state.activeLib = libName;
  state.activeSubfolder = null;
  setActiveLib(libName);

  const lib = state.libraries.find(l => l.name === libName) || { rawName: libName, color: '#737373', icon: 'üìÅ' };
  updateBreadcrumb([{ label: lib.rawName, color: lib.color }]);

  const content = document.getElementById('contentArea');
  content.innerHTML = '<div class="loading"><div class="spin"></div><span>≈Åadowanie...</span></div>';

  try {
    // Pobierz subkatalogi
    const res = await fetch(API + '/api/browse/files?root=lib&cat=' + encodeURIComponent(libName));
    const filesData = res.ok ? await res.json() : null;

    // Pobierz listƒô podfolder√≥w
    const subRes = await fetch(API + '/api/browse/categories?root=lib');
    // subfolders przez browse/categories ale tylko dla tego lib ‚Äî nie ma takiego endpoint
    // dlatego pobieramy pliki z katalogu

    renderLibContent(libName, lib, filesData);
  } catch(e) {
    content.innerHTML = `<div class="empty"><div class="empty-icon">‚ùå</div><div class="empty-msg">B≈ÇƒÖd ≈Çadowania: ${e.message}</div></div>`;
  }
}

async function renderLibContent(libName, lib, filesData) {
  const content = document.getElementById('contentArea');

  // Pobierz pliki root + subkatalogi przez browse API
  let rootFiles = filesData ? filesData.files : [];
  state.allFiles = rootFiles;
  state.files = rootFiles;

  // Pobierz subkatalogi (przez knowledge API)
  let subfolders = [];
  try {
    const r = await fetch(API + '/api/knowledge/list?source=lib&cat=' + encodeURIComponent(libName));
    if (r.ok) {
      const d = await r.json();
      subfolders = d.categories || [];
    }
  } catch(e) {}

  let html = '';

  // Subfolders
  if (subfolders.length) {
    html += `<div class="section-lbl">üìÅ Podfoldery <span style="color:var(--muted);font-weight:400">(${subfolders.length})</span></div>`;
    html += '<div class="folder-grid">';
    subfolders.forEach(sf => {
      html += `<div class="folder-card" onclick="selectSubfolder('${esc(libName)}','${esc(sf.name)}')">
        <span class="fc-ico">üìÇ</span>
        <div class="fc-info">
          <div class="fc-n">${sf.name}</div>
          <div class="fc-s">${sf.files} pliki ¬∑ ${sf.subfolders} podfold.</div>
        </div>
      </div>`;
    });
    html += '</div>';
  }

  // Root files
  if (rootFiles.length) {
    html += `<div class="section-lbl">üìÑ Pliki root <span style="color:var(--muted);font-weight:400">(${rootFiles.length})</span></div>`;
    html += renderFileList(rootFiles);
  } else if (!subfolders.length) {
    html = '<div class="empty"><div class="empty-icon">üì≠</div><div class="empty-msg">Brak plik√≥w</div><div class="empty-sub">Biblioteka pusta</div></div>';
  }

  content.innerHTML = html;
  document.getElementById('fileCount').textContent = rootFiles.length + ' pliki';
}

// ================================================================
// SELECT SUBFOLDER
// ================================================================
async function selectSubfolder(libName, subfolder) {
  state.activeSubfolder = subfolder;
  const lib = state.libraries.find(l => l.name === libName) || { rawName: libName };

  updateBreadcrumb([
    { label: lib.rawName, onclick: `selectLib('${esc(libName)}')` },
    { label: subfolder }
  ]);

  const content = document.getElementById('contentArea');
  content.innerHTML = '<div class="loading"><div class="spin"></div><span>≈Åadowanie...</span></div>';

  try {
    const catPath = libName + '/' + subfolder;
    const res = await fetch(API + '/api/browse/files?root=lib&cat=' + encodeURIComponent(catPath));
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    state.allFiles = data.files;
    state.files = data.files;

    // Spr√≥buj wczytaƒá subpodfoldery
    let subHTML = '';
    try {
      const r2 = await fetch(API + '/api/knowledge/list?source=lib&cat=' + encodeURIComponent(catPath));
      if (r2.ok) {
        const d2 = await r2.json();
        const subs = d2.categories || [];
        if (subs.length) {
          subHTML += `<div class="section-lbl">üìÅ Podfoldery</div><div class="folder-grid">`;
          subs.forEach(sf => {
            subHTML += `<div class="folder-card" onclick="selectSubfolder('${esc(libName)}','${esc(subfolder + '/' + sf.name)}')">
              <span class="fc-ico">üìÇ</span>
              <div class="fc-info"><div class="fc-n">${sf.name}</div><div class="fc-s">${sf.files} pliki</div></div>
            </div>`;
          });
          subHTML += '</div>';
        }
      }
    } catch(e) {}

    let html = subHTML;
    if (data.files.length) {
      html += `<div class="section-lbl">üìÑ Pliki <span style="color:var(--muted);font-weight:400">(${data.files.length})</span></div>`;
      html += renderFileList(data.files);
    } else if (!subHTML) {
      html = '<div class="empty"><div class="empty-icon">üì≠</div><div class="empty-msg">Brak plik√≥w</div></div>';
    }
    content.innerHTML = html;
    document.getElementById('fileCount').textContent = data.files.length + ' pliki';
  } catch(e) {
    content.innerHTML = `<div class="empty"><div class="empty-icon">‚ùå</div><div class="empty-msg">${e.message}</div></div>`;
  }
}

// ================================================================
// FILE LIST / GRID RENDER
// ================================================================
function renderFileList(files) {
  if (state.view === 'grid') {
    return '<div class="file-grid">' + files.map(f => fileCard(f)).join('') + '</div>';
  }
  return '<div class="file-list">' + files.map(f => fileRow(f)).join('') + '</div>';
}

function fileRow(f) {
  const ext = (f.ext || '').replace('.','').toLowerCase();
  const date = f.modified ? f.modified.slice(0,10) : '';
  return `<div class="file-item" onclick="openFile('${esc(f.name)}')">
    <div class="file-ext ${ext}">${ext || '?'}</div>
    <div class="file-info">
      <div class="file-name">${f.name}</div>
      <div class="file-meta">${f.sizeHuman || ''}</div>
    </div>
    <div class="file-date">${date}</div>
  </div>`;
}

function fileCard(f) {
  const ext = (f.ext || '').replace('.','').toLowerCase();
  return `<div class="file-card" onclick="openFile('${esc(f.name)}')">
    <div class="fc-ext">${ext || '?'}</div>
    <div class="fc-name">${f.name}</div>
    <div class="fc-meta">${f.sizeHuman || ''}</div>
  </div>`;
}

function filterFiles(q) {
  q = q.toLowerCase();
  state.files = state.allFiles.filter(f => f.name.toLowerCase().includes(q));
  const c = document.getElementById('contentArea');
  // Only update file list part
  const html = renderFileList(state.files);
  // Replace just the list section ‚Äî simple approach: re-render only list
  const listEl = c.querySelector('.file-list, .file-grid');
  if (listEl) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    listEl.replaceWith(tmp.firstChild);
  }
  document.getElementById('fileCount').textContent = state.files.length + ' pliki';
}

// ================================================================
// OPEN FILE (reader)
// ================================================================
async function openFile(filename) {
  if (!state.activeLib) return;

  let catParam = state.activeLib;
  if (state.activeSubfolder) catParam = state.activeLib + '/' + state.activeSubfolder;

  const overlay = document.getElementById('readerOverlay');
  const contentEl = document.getElementById('rdrContent');
  const extEl = document.getElementById('rdrExt');
  const nameEl = document.getElementById('rdrName');
  const metaEl = document.getElementById('rdrMeta');

  nameEl.textContent = filename;
  const ext = filename.split('.').pop().toLowerCase();
  extEl.textContent = ext;
  extEl.className = 'rh-ext';
  contentEl.textContent = '≈Åadowanie...';
  contentEl.className = 'reader-content';
  overlay.style.display = 'flex';

  try {
    const url = API + '/api/browse/read?root=lib&cat=' + encodeURIComponent(catParam) + '&file=' + encodeURIComponent(filename);
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status + ': ' + res.statusText);
    const data = await res.json();

    metaEl.textContent = data.sizeHuman + ' ¬∑ ' + data.lines + ' linii';
    state.rawContent = data.content;
    state.renderedContent = ext === 'md' ? renderMd(data.content) : escHtml(data.content);
    state.readerTab = 'rendered';
    showReaderTab('rendered');
  } catch(e) {
    contentEl.textContent = 'B≈ÇƒÖd: ' + e.message;
  }
}

function closeReader(e) {
  if (!e || e.target === document.getElementById('readerOverlay')) {
    document.getElementById('readerOverlay').style.display = 'none';
  }
}

function switchTab(tab) {
  state.readerTab = tab;
  showReaderTab(tab);
}

function showReaderTab(tab) {
  document.getElementById('tabRendered').className = 'reader-tab' + (tab === 'rendered' ? ' active' : '');
  document.getElementById('tabRaw').className = 'reader-tab' + (tab === 'raw' ? ' active' : '');
  document.getElementById('tabHtml').className = 'reader-tab' + (tab === 'html' ? ' active' : '');
  const el = document.getElementById('rdrContent');
  const ext = document.getElementById('rdrExt').textContent;
  if (tab === 'raw') {
    el.className = 'reader-content';
    el.textContent = state.rawContent;
  } else if (tab === 'html') {
    el.className = 'reader-content';
    el.textContent = buildHtmlOutput();
  } else {
    if (ext === 'md') {
      el.className = 'reader-content md-rendered';
      el.innerHTML = state.renderedContent;
    } else {
      el.className = 'reader-content';
      el.textContent = state.rawContent;
    }
  }
}

// Zamie≈Ñ surowy Markdown w pe≈Çne HTML do czytania (z linkami, TOC, tabelami)
function buildHtmlOutput() {
  const name = document.getElementById('rdrName').textContent;
  const ext  = document.getElementById('rdrExt').textContent;
  const raw  = state.rawContent;

  // Zbuduj tre≈õƒá
  let bodyHtml;
  if (ext === 'md') {
    bodyHtml = mdToHtml(raw);
  } else if (ext === 'json') {
    try {
      const pretty = JSON.stringify(JSON.parse(raw), null, 2);
      bodyHtml = '<pre class="json">' + escHtml(pretty) + '</pre>';
    } catch(e) {
      bodyHtml = '<pre>' + escHtml(raw) + '</pre>';
    }
  } else {
    bodyHtml = '<pre>' + escHtml(raw) + '</pre>';
  }

  // WyciƒÖgnij nag≈Ç√≥wki do TOC
  const tocItems = [];
  const hRe = /<h([23]) id="([^"]+)">([^<]+)<\/h[23]>/g;
  let m;
  while ((m = hRe.exec(bodyHtml)) !== null) {
    tocItems.push({ level: parseInt(m[1]), id: m[2], text: m[3] });
  }
  const tocHtml = tocItems.length > 1 ? `
    <nav class="toc">
      <div class="toc-title">Spis tre≈õci</div>
      <ul>${tocItems.map(t =>
        `<li class="toc-h${t.level}"><a href="#${t.id}">${t.text}</a></li>`
      ).join('')}</ul>
    </nav>` : '';

  const libPath = state.activeSubfolder
    ? `${state.activeLib} / ${state.activeSubfolder}`
    : (state.activeLib || '');

  return `<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${escHtml(name)} ‚Äî DEVz HUB</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:      #0d1117;
  --surface: #161b22;
  --border:  #30363d;
  --text:    #e6edf3;
  --muted:   #8b949e;
  --dim:     #484f58;
  --green:   #3fb950;
  --cyan:    #58a6ff;
  --purple:  #bc8cff;
  --yellow:  #e3b341;
  --red:     #f85149;
  --accent:  #238636;
}

body {
  font-family: -apple-system, 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 15px;
  line-height: 1.7;
}

/* === LAYOUT === */
.page-wrap {
  display: flex;
  min-height: 100vh;
}

/* Sidebar TOC */
.toc-sidebar {
  width: 240px;
  flex-shrink: 0;
  position: sticky;
  top: 0;
  height: 100vh;
  overflow-y: auto;
  background: var(--surface);
  border-right: 1px solid var(--border);
  padding: 24px 0;
}
.toc-sidebar::-webkit-scrollbar { width: 4px; }
.toc-sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.toc { padding: 0 16px; }
.toc-title {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  color: var(--dim);
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}
.toc ul { list-style: none; }
.toc li { margin: 0; }
.toc-h2 { padding: 3px 0; }
.toc-h3 { padding: 2px 0 2px 12px; }
.toc a {
  font-size: 12px;
  color: var(--muted);
  text-decoration: none;
  display: block;
  border-radius: 4px;
  padding: 2px 6px;
  transition: all .15s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.toc-h2 a { color: var(--text); font-weight: 500; }
.toc a:hover { color: var(--cyan); background: rgba(88,166,255,.08); }

/* Brak TOC ‚Äî bez sidebara */
.no-toc .toc-sidebar { display: none; }
.no-toc .content { max-width: 860px; margin: 0 auto; }

/* Main content */
.content {
  flex: 1;
  min-width: 0;
  padding: 40px 48px;
  max-width: 900px;
}

/* === TOPBAR === */
.topbar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 12px;
  color: var(--muted);
  position: sticky;
  top: 0;
  z-index: 10;
}
.topbar .brand { color: var(--green); font-weight: 700; }
.topbar .sep { color: var(--dim); }
.topbar .fname { color: var(--text); font-weight: 600; }
.topbar .ext-badge {
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  padding: 2px 7px;
  border-radius: 4px;
  background: rgba(63,185,80,.12);
  color: var(--green);
  margin-left: auto;
}
.topbar .ts { margin-left: 8px; color: var(--dim); }
.topbar a.back {
  color: var(--cyan);
  text-decoration: none;
  font-weight: 500;
}
.topbar a.back:hover { text-decoration: underline; }

/* === CONTENT STYLES === */
h1 {
  font-size: 26px;
  font-weight: 700;
  color: #fff;
  border-bottom: 1px solid var(--border);
  padding-bottom: 12px;
  margin-bottom: 20px;
  margin-top: 8px;
  line-height: 1.3;
}
h2 {
  font-size: 19px;
  font-weight: 700;
  color: var(--text);
  margin: 32px 0 12px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
  scroll-margin-top: 60px;
}
h3 {
  font-size: 15px;
  font-weight: 700;
  color: var(--cyan);
  margin: 22px 0 8px;
  scroll-margin-top: 60px;
}
h4 {
  font-size: 13px;
  font-weight: 700;
  color: var(--purple);
  margin: 16px 0 6px;
}

p { margin: 10px 0; color: var(--text); }

a {
  color: var(--cyan);
  text-decoration: none;
  border-bottom: 1px solid rgba(88,166,255,.3);
  transition: border-color .15s, color .15s;
  word-break: break-all;
}
a:hover { color: #79c0ff; border-bottom-color: #79c0ff; }

/* URL-e jako linki */
.auto-url {
  color: var(--cyan);
  font-size: 12px;
  font-family: monospace;
}

strong, b { color: #fff; font-weight: 600; }
em, i { color: #cdd9e5; font-style: italic; }

ul, ol { padding-left: 22px; margin: 8px 0; }
li { margin: 4px 0; color: var(--text); }
li::marker { color: var(--green); }

code {
  font-family: 'Cascadia Code', 'Consolas', monospace;
  font-size: 12px;
  background: rgba(255,255,255,.06);
  color: var(--cyan);
  padding: 2px 6px;
  border-radius: 4px;
  border: 1px solid var(--border);
}

pre {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 18px;
  overflow-x: auto;
  margin: 12px 0;
  font-family: 'Cascadia Code', 'Consolas', monospace;
  font-size: 12px;
  line-height: 1.6;
  color: #e6edf3;
  white-space: pre-wrap;
  word-break: break-word;
}
pre code { background: none; border: none; padding: 0; color: inherit; font-size: inherit; }
pre.json { color: #e3b341; }

hr {
  border: none;
  border-top: 1px solid var(--border);
  margin: 24px 0;
}

blockquote {
  border-left: 3px solid var(--green);
  padding: 8px 16px;
  margin: 12px 0;
  background: rgba(63,185,80,.05);
  border-radius: 0 6px 6px 0;
  color: var(--muted);
  font-style: italic;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin: 14px 0;
  font-size: 13px;
}
th {
  text-align: left;
  padding: 8px 12px;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--muted);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: .8px;
  font-weight: 700;
}
td {
  padding: 8px 12px;
  border: 1px solid var(--border);
  color: var(--text);
  vertical-align: top;
}
tr:nth-child(even) td { background: rgba(255,255,255,.02); }
tr:hover td { background: rgba(88,166,255,.04); }

/* Admonitions (emoji prefix) */
.note {
  background: rgba(88,166,255,.07);
  border-left: 3px solid var(--cyan);
  border-radius: 0 6px 6px 0;
  padding: 10px 14px;
  margin: 12px 0;
  font-size: 13px;
}

/* Footer */
.footer {
  margin-top: 48px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
  font-size: 11px;
  color: var(--dim);
  display: flex;
  justify-content: space-between;
}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <span class="brand">DEVz HUB</span>
  <span class="sep">/</span>
  <span>${escHtml(libPath)}</span>
  <span class="sep">/</span>
  <span class="fname">${escHtml(name)}</span>
  <span class="ext-badge">${escHtml(ext)}</span>
  <span class="ts">Wygenerowano: ${new Date().toLocaleString('pl-PL')}</span>
</div>

<div class="page-wrap ${tocItems.length > 1 ? '' : 'no-toc'}">
  ${tocItems.length > 1 ? `<aside class="toc-sidebar">${tocHtml}</aside>` : ''}
  <main class="content">
    ${bodyHtml}
    <div class="footer">
      <span>knowledge_base/_LIBRARIES &middot; ${escHtml(libPath)} &middot; ${escHtml(name)}</span>
      <span>${new Date().toISOString()}</span>
    </div>
  </main>
</div>

</body>
</html>`;
}

// Pe≈Çny konwerter Markdown ‚Üí HTML z linkami, tabelami, TOC-id
function mdToHtml(md) {
  let lines = md.split('\n');
  let html = '';
  let inPre = false, inTable = false, inUl = false, inOl = false;
  let headingCount = {};

  function slugify(text) {
    return text.toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-');
  }
  function uniqueId(text) {
    const slug = slugify(text);
    headingCount[slug] = (headingCount[slug] || 0) + 1;
    return headingCount[slug] === 1 ? slug : slug + '-' + headingCount[slug];
  }

  function closeLists() {
    let c = '';
    if (inUl) { c += '</ul>'; inUl = false; }
    if (inOl) { c += '</ol>'; inOl = false; }
    return c;
  }
  function closeTable() {
    let c = '';
    if (inTable) { c += '</tbody></table>'; inTable = false; }
    return c;
  }

  function inlineFormat(text) {
    // Code spans ‚Äî najpierw
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Bold+italic
    text = text.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
    // Bold
    text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/__(.+?)__/g, '<strong>$1</strong>');
    // Italic
    text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
    text = text.replace(/_([^_]+)_/g, '<em>$1</em>');
    // Strikethrough
    text = text.replace(/~~(.+?)~~/g, '<del>$1</del>');
    // Links [text](url)
    text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g,
      '<a href="$2" target="_blank" rel="noopener">$1</a>');
    text = text.replace(/\[([^\]]+)\]\(([^\)]+)\)/g,
      '<a href="$2">$1</a>');
    // Bare URLs
    text = text.replace(/(^|[\s(>])((https?:\/\/)[^\s<)"]+)/g,
      '$1<a href="$2" target="_blank" rel="noopener" class="auto-url">$2</a>');
    return text;
  }

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    // Fenced code blocks
    if (line.startsWith('```') || line.startsWith('~~~')) {
      if (inPre) {
        html += '</code></pre>\n';
        inPre = false;
      } else {
        html += closeLists() + closeTable();
        const lang = line.slice(3).trim();
        html += `<pre><code class="lang-${escHtml(lang)}">`;
        inPre = true;
      }
      continue;
    }
    if (inPre) {
      html += escHtml(line) + '\n';
      continue;
    }

    // Headings
    const hm = line.match(/^(#{1,4})\s+(.+)$/);
    if (hm) {
      html += closeLists() + closeTable();
      const level = hm[1].length;
      const text = hm[2].trim();
      const id = uniqueId(text);
      const tag = 'h' + level;
      html += `<${tag} id="${id}">${inlineFormat(escHtml(text))}</${tag}>\n`;
      continue;
    }

    // HR
    if (/^[-*_]{3,}$/.test(line.trim())) {
      html += closeLists() + closeTable() + '<hr>\n';
      continue;
    }

    // Blockquote
    if (line.startsWith('> ')) {
      html += closeLists() + closeTable();
      html += `<blockquote>${inlineFormat(escHtml(line.slice(2)))}</blockquote>\n`;
      continue;
    }

    // Tables ‚Äî header | separator | rows
    if (line.includes('|') && line.trim().startsWith('|')) {
      const cells = line.trim().replace(/^\||\|$/g, '').split('|').map(c => c.trim());
      if (!inTable) {
        // Check if next line is separator
        const nextLine = lines[i+1] || '';
        if (nextLine.match(/^\|[\s|:-]+\|/)) {
          html += closeLists();
          html += '<table><thead><tr>';
          html += cells.map(c => `<th>${inlineFormat(escHtml(c))}</th>`).join('');
          html += '</tr></thead><tbody>\n';
          inTable = true;
          i++; // skip separator
          continue;
        }
      } else {
        // Check if separator line
        if (cells.every(c => /^:?-+:?$/.test(c.trim()))) continue;
        html += '<tr>';
        html += cells.map(c => `<td>${inlineFormat(escHtml(c))}</td>`).join('');
        html += '</tr>\n';
        continue;
      }
    } else if (inTable) {
      html += closeTable();
    }

    // Unordered list
    const ulm = line.match(/^(\s*)[-*+]\s+(.+)$/);
    if (ulm) {
      if (!inUl) { html += closeTable(); html += '<ul>'; inUl = true; }
      html += `<li>${inlineFormat(escHtml(ulm[2]))}</li>\n`;
      continue;
    }

    // Ordered list
    const olm = line.match(/^(\s*)\d+[.)]\s+(.+)$/);
    if (olm) {
      if (!inOl) { html += closeLists() + closeTable(); html += '<ol>'; inOl = true; }
      html += `<li>${inlineFormat(escHtml(olm[2]))}</li>\n`;
      continue;
    }

    // Close lists if not a list line
    if (inUl || inOl) html += closeLists();

    // Empty line
    if (line.trim() === '') {
      html += '\n';
      continue;
    }

    // Regular paragraph
    html += `<p>${inlineFormat(escHtml(line))}</p>\n`;
  }

  // Close any open structures
  html += closeLists() + closeTable();
  if (inPre) html += '</code></pre>';

  return html;
}

function saveAsHtml() {
  const name = document.getElementById('rdrName').textContent;
  const html = buildHtmlOutput();
  // Otw√≥rz w nowej karcie jako blob
  const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const win = window.open(url, '_blank');
  // Revoke po chwili (nowa karta ju≈º wczyta≈Ça)
  setTimeout(() => URL.revokeObjectURL(url), 10000);
}

// Simple Markdown renderer
function renderMd(md) {
  let h = escHtml(md);
  // Headers
  h = h.replace(/^### (.+)$/gm, '<h3 style="color:var(--cyan);font-size:13px;margin:14px 0 6px">$1</h3>');
  h = h.replace(/^## (.+)$/gm, '<h2 style="color:var(--green);font-size:15px;margin:16px 0 8px">$1</h2>');
  h = h.replace(/^# (.+)$/gm, '<h1 style="color:var(--strong);font-size:18px;margin:16px 0 8px">$1</h1>');
  // Bold, italic
  h = h.replace(/\*\*(.+?)\*\*/g, '<strong style="color:var(--strong)">$1</strong>');
  h = h.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Code inline
  h = h.replace(/`(.+?)`/g, '<code style="background:rgba(255,255,255,0.06);padding:1px 5px;border-radius:3px;font-family:monospace;font-size:11px;color:var(--cyan)">$1</code>');
  // HR
  h = h.replace(/^---$/gm, '<hr style="border:none;border-top:1px solid var(--b);margin:12px 0">');
  // Lists
  h = h.replace(/^[-*] (.+)$/gm, '<li style="margin:2px 0;padding-left:4px">$1</li>');
  h = h.replace(/^(\d+)\. (.+)$/gm, '<li style="margin:2px 0;padding-left:4px">$2</li>');
  // Paragraphs
  h = h.replace(/\n\n/g, '</p><p style="margin:6px 0">');
  h = '<p style="margin:6px 0">' + h + '</p>';
  return h;
}

// ================================================================
// NAVIGATION HELPERS
// ================================================================
function goHome() {
  renderHome();
}

function updateBreadcrumb(parts) {
  const el = document.getElementById('breadcrumb');
  let html = '<span class="bc-lib" onclick="goHome()">Biblioteki</span>';
  parts.forEach((p, i) => {
    html += '<span class="bc-sep">/</span>';
    const isLast = i === parts.length - 1;
    if (p.onclick && !isLast) {
      html += `<span class="bc-lib" onclick="${p.onclick}">${p.label}</span>`;
    } else if (i === 0) {
      html += `<span class="bc-cat" style="color:${p.color || 'var(--cyan)'}">${p.label}</span>`;
    } else {
      html += `<span class="bc-subcat">${p.label}</span>`;
    }
  });
  el.innerHTML = html;
}

function setView(v) {
  state.view = v;
  document.getElementById('btnList').className = 'view-btn' + (v === 'list' ? ' active' : '');
  document.getElementById('btnGrid').className = 'view-btn' + (v === 'grid' ? ' active' : '');
  // Re-render current files
  const content = document.getElementById('contentArea');
  const listEl = content.querySelector('.file-list, .file-grid');
  if (listEl && state.files.length) {
    const tmp = document.createElement('div');
    tmp.innerHTML = renderFileList(state.files);
    listEl.replaceWith(tmp.firstChild);
  }
}

function updateTopStat() {
  const biz = state.libraries.filter(l => l.prefix === 'BIZ').length;
  const prv = state.libraries.filter(l => l.prefix === 'PRV').length;
  document.getElementById('topStat').textContent = `${biz} BIZ ¬∑ ${prv} PRV`;
}

// ================================================================
// STATUS
// ================================================================
function setOnline(ok, label) {
  ['statusDot', 'topDot'].forEach(id => {
    const el = document.getElementById(id);
    el.className = 'dot ' + (ok ? 'ok' : 'err');
  });
  document.getElementById('statusLabel').textContent = label;
  document.getElementById('topLabel').textContent = ok ? 'API Online' : 'Offline';
}

function showError(msg, sub) {
  document.getElementById('libTree').innerHTML = `<div style="padding:16px;font-size:11px">
    <div style="color:var(--red);margin-bottom:6px">‚ùå ${msg}</div>
    <div style="color:var(--dim)">${sub}</div>
  </div>`;
  document.getElementById('contentArea').innerHTML = `<div class="empty">
    <div class="empty-icon">üîå</div>
    <div class="empty-msg">${msg}</div>
    <div class="empty-sub">${sub}</div>
  </div>`;
}

// ================================================================
// UTILS
// ================================================================
function esc(s) { return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'"); }
function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Keyboard: Escape closes reader
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeReader();
});

// ================================================================
// BOOT
// ================================================================
init();
</script>
</body>
</html>
